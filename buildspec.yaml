version: 0.2
phases:
  install:
     runtime-versions:
        java: corretto11
      #  maven: apache-maven-3.9.9
  pre_build:
     commands:
       - echo "installing the kubectl "
       - curl -o kubectl https://amazon-eks.s3.eu-north-1.amazonaws.com/1.27.6/2023-05-17/bin/linux/amd64/kubectl
       - chmod +x ./kubectl
       - mv ./kubectl /usr/local/bin/kubectl
       - kubectl version --client
       - echo "Logging in to Amazon ECR.."
       - aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin 494713367427.dkr.ecr.eu-north-1.amazonaws.com
  build:
     commands:
       - echo "clean the mvn repo"
       - mvn clean
       - echo "code build begin"
       - mvn compile package
       - echo "build a docker image"
       - docker build -t dhaneesh/dha:latest .
  post_build:
     commands:
       - echo "pushing the image to aws ECR"
       - docker tag  dhaneesh/dha:latest 494713367427.dkr.ecr.eu-north-1.amazonaws.com/dhaneesh/dharun:first
       - docker push 494713367427.dkr.ecr.eu-north-1.amazonaws.com/dhaneesh/dharun:first
       - echo login into eks cluster
       - aws eks --region eu-north-1 update-kubeconfig --name your-dhaneesh-ekscluster
       - echo "deploying it in ekscluster"
       - kubectl apply -f deployment.yaml
       - kubectl apply -f service.yaml
       - kubectl rollout status deployment/dhaneesh-deployment
       
      